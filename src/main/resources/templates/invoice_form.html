<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="sk-SK">
<head>
    <title>Create invoice</title>
    <meta charset="UTF-8"/>
    <link rel="stylesheet" th:href="@{/css/form_style.css}" />
</head>
<body>
<form th:action="@{/invoices/new}" th:object="${invoice}" method="post">

    <div class="flex-container">
        <div>
            <!-- Issuer -->
            <h2>Issuer</h2>

            <label for="issuerName">Name:</label>
            <input type="text" th:field="*{issuer.name}" id="issuerName" />
            <div th:if="${#fields.hasErrors('issuer.name')}" th:errors="*{issuer.name}" class="field-error"></div>

            <label for="issuerStreet">Street:</label>
            <input type="text" th:field="*{issuer.street}" id="issuerStreet" />
            <div th:if="${#fields.hasErrors('issuer.street')}" th:errors="*{issuer.street}" class="field-error"></div>

            <label for="issuerHouseNumber">House number:</label>
            <input type="text" th:field="*{issuer.houseNumber}" id="issuerHouseNumber" />
            <div th:if="${#fields.hasErrors('issuer.houseNumber')}" th:errors="*{issuer.houseNumber}" class="field-error"></div>

            <label for="issuerCity">City:</label>
            <input type="text" th:field="*{issuer.city}" id="issuerCity"/>
            <div th:if="${#fields.hasErrors('issuer.city')}" th:errors="*{issuer.city}" class="field-error"></div>

            <label for="issuerPostalCode">Postal code:</label>
            <input type="text" th:field="*{issuer.postalCode}" id="issuerPostalCode"/>
            <div th:if="${#fields.hasErrors('issuer.postalCode')}" th:errors="*{issuer.postalCode}" class="field-error"></div>

            <label for="issuerIco">IČO:</label>
            <input type="text" th:field="*{issuer.ico}" id="issuerIco"/>
            <div th:if="${#fields.hasErrors('issuer.ico')}" th:errors="*{issuer.ico}" class="field-error"></div>

            <label for="issuerDic">DIČ:</label>
            <input type="text" th:field="*{issuer.dic}" id="issuerDic"/>
            <div th:if="${#fields.hasErrors('issuer.dic')}" th:errors="*{issuer.dic}" class="field-error"></div>

            <label for="issuerPhone">Phone:</label>
            <input type="text" th:field="*{issuer.phone}" id="issuerPhone"/>
            <div th:if="${#fields.hasErrors('issuer.phone')}" th:errors="*{issuer.phone}" class="field-error"></div>

            <label for="issuerEmail">Email:</label>
            <input type="email" th:field="*{issuer.email}" id="issuerEmail"/>
            <div th:if="${#fields.hasErrors('issuer.email')}" th:errors="*{issuer.email}" class="field-error"></div>

            <label for="issuerBankAccount">Bank account:</label>
            <input type="text" th:field="*{issuer.bankAccount}" id="issuerBankAccount"/>
            <div th:if="${#fields.hasErrors('issuer.bankAccount')}" th:errors="*{issuer.bankAccount}" class="field-error"></div>
        </div>
        <div>
            <!-- Client -->
            <h2>Client</h2>

            <label for="clientName">Name:</label>
            <input type="text" th:field="*{client.name}" id="clientName"/>
            <div th:if="${#fields.hasErrors('client.name')}" th:errors="*{client.name}" class="field-error"></div>

            <label for="clientStreet">Street:</label>
            <input type="text" th:field="*{client.street}" id="clientStreet"/>
            <div th:if="${#fields.hasErrors('client.street')}" th:errors="*{client.street}" class="field-error"></div>

            <label for="clientHouseNumber">House number:</label>
            <input type="text" th:field="*{client.houseNumber}" id="clientHouseNumber"/>
            <div th:if="${#fields.hasErrors('client.houseNumber')}" th:errors="*{client.houseNumber}" class="field-error"></div>

            <label for="clientCity">City:</label>
            <input type="text" th:field="*{client.city}" id="clientCity"/>
            <div th:if="${#fields.hasErrors('client.city')}" th:errors="*{client.city}" class="field-error"></div>

            <label for="clientPostalCode">Postal code:</label>
            <input type="text" th:field="*{client.postalCode}" id="clientPostalCode"/>
            <div th:if="${#fields.hasErrors('client.postalCode')}" th:errors="*{client.postalCode}" class="field-error"></div>

            <label for="clientIco">IČO:</label>
            <input type="text" th:field="*{client.ico}" id="clientIco"/>
            <div th:if="${#fields.hasErrors('client.ico')}" th:errors="*{client.ico}" class="field-error"></div>

            <label for="clientDic">DIČ:</label>
            <input type="text" th:field="*{client.dic}" id="clientDic"/>
            <div th:if="${#fields.hasErrors('client.dic')}" th:errors="*{client.dic}" class="field-error"></div>
        </div>
    </div>

    <!-- Billing details -->
    <h2>Billing details</h2>

    <div class="flex-container">
        <div>
            <label for="invoiceNumber">Invoice number:</label>
            <input type="text" th:field="*{invoiceNumber}" id="invoiceNumber"/>
            <div th:if="${#fields.hasErrors('invoiceNumber')}" th:errors="*{invoiceNumber}" class="field-error"></div>
        </div>
        <div>
            <label for="variableSymbol">Variable symbol:</label>
            <input type="text" th:field="*{variableSymbol}" id="variableSymbol"/>
            <div th:if="${#fields.hasErrors('variableSymbol')}" th:errors="*{variableSymbol}" class="field-error"></div>
        </div>
    </div>

    <!-- Dates -->
    <div class="flex-container dates">
        <div>
            <label for="issueDate">Issue Date:</label>
            <input type="date" th:field="*{issueDate}" id="issueDate"/>
            <div th:if="${#fields.hasErrors('issueDate')}" th:errors="*{issueDate}" class="field-error"></div>
        </div>
        <div>
            <label for="deliveryDate">Delivery Date:</label>
            <input type="date" th:field="*{deliveryDate}" id="deliveryDate"/>
            <div th:if="${#fields.hasErrors('deliveryDate')}" th:errors="*{deliveryDate}" class="field-error"></div>
        </div>
        <div>
            <label for="dueDate">Due Date:</label>
            <input type="date" th:field="*{dueDate}" id="dueDate"/>
            <div th:if="${#fields.hasErrors('dueDate')}" th:errors="*{dueDate}" class="field-error"></div>
        </div>
    </div>

    <!-- Invoice Items -->
    <h2>Invoice Items</h2>

    <div id="items-container">
        <div th:each="item, iterStat : *{items}" class="invoice-item">
            <label th:for="'items[' + ${iterStat.index} + '].description'">Description:</label>
            <label>
                <input type="text" th:field="*{items[__${iterStat.index}__].description}" />
            </label>
            <div th:if="${#fields.hasErrors('items[' + iterStat.index + '].description')}"
                 th:errors="*{items[__${iterStat.index}__].description}" class="field-error"></div>

            <label th:for="'items[' + ${iterStat.index} + '].quantity'">Quantity:</label>
            <label>
                <input type="number" th:field="*{items[__${iterStat.index}__].quantity}" />
            </label>
            <div th:if="${#fields.hasErrors('items[' + iterStat.index + '].quantity')}"
                 th:errors="*{items[__${iterStat.index}__].quantity}" class="field-error"></div>

            <label th:for="'items[' + ${iterStat.index} + '].unitPrice'">Unit Price:</label>
            <label>
                <input type="number" th:field="*{items[__${iterStat.index}__].unitPrice}" />
            </label>
            <div th:if="${#fields.hasErrors('items[' + iterStat.index + '].unitPrice')}"
                 th:errors="*{items[__${iterStat.index}__].unitPrice}" class="field-error"></div>

            <button type="button" onclick="removeItem(this)">Delete</button>
        </div>
        <div th:if="${#fields.hasErrors('items')}" th:errors="*{items}" class="field-error"></div>
    </div>
    <div id="item-template" style="display:none;">
        <div class="invoice-item">
            <label>Description:</label>
            <label>
                <input type="text" data-name="items[__index__].description"/>
            </label>

            <label>Quantity:</label>
            <label>
                <input type="number" data-name="items[__index__].quantity"/>
            </label>

            <label>Unit Price:</label>
            <label>
                <input type="number" data-name="items[__index__].unitPrice"/>
            </label>

            <button type="button" onclick="removeItem(this)">Delete</button>
        </div>
    </div>

    <button type="button" onclick="addItem()">Add item</button>
    <button type="submit">Save</button>
    <button type="button" onclick="window.location.href='/invoices'">Back</button>
</form>

<script>
    function addItem() {
        const container = document.getElementById("items-container");
        const template = document.getElementById("item-template").innerHTML;

        const index = container.querySelectorAll(".invoice-item").length;
        const wrapper = document.createElement("div");
        wrapper.innerHTML = template;

        const inputs = wrapper.querySelectorAll("[data-name]");
        inputs.forEach(input => {
            const nameTemplate = input.getAttribute("data-name");
            input.setAttribute("name", nameTemplate.replaceAll("__index__", String(index)));
            input.removeAttribute("data-name");
        });

        container.appendChild(wrapper);
    }

    function removeItem(button) {
        const itemDiv = button.closest(".invoice-item");
        itemDiv.remove();
        reindexItems();
    }

    function reindexItems() {
        const itemDivs = document.querySelectorAll(".invoice-item");
        itemDivs.forEach((div, index) => {
            div.querySelectorAll("input, select").forEach(input => {
                const name = input.getAttribute("name");
                if (name) {
                    const newName = name.replace(/items\[\d+]/, `items[${index}]`);
                    input.setAttribute("name", newName);
                    input.setAttribute("id", newName);
                }
            });
        });
    }
</script>
</body>
</html>