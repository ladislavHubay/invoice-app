<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="sk-SK">
<head>
    <title>Vytvorenie faktury</title>
    <meta charset="UTF-8"/>
</head>
<body>
<h1>Vytvorit fakturu</h1>

<form th:action="@{/invoices/new}" th:object="${invoice}" method="post">
    <h2>Udaje vystavitela</h2>

    <label for="issuerName">Meno: </label>
    <input type="text" th:field="*{issuer.name}" id="issuerName" />
    <div th:if="${#fields.hasErrors('issuer.name')}" th:errors="*{issuer.name}"></div>
    <hr/>

    <label for="issuerStreet">Ulica: </label>
    <input type="text" th:field="*{issuer.street}" id="issuerStreet" />
    <div th:if="${#fields.hasErrors('issuer.street')}" th:errors="*{issuer.street}"></div>
    <hr/>

    <label for="issuerHouseNumber">Cislo domu: </label>
    <input type="text" th:field="*{issuer.houseNumber}" id="issuerHouseNumber" />
    <div th:if="${#fields.hasErrors('issuer.houseNumber')}" th:errors="*{issuer.houseNumber}"></div>
    <hr/>

    <label for="issuerCity">Mesto: </label>
    <input type="text" th:field="*{issuer.city}" id="issuerCity"/>
    <div th:if="${#fields.hasErrors('issuer.city')}" th:errors="*{issuer.city}"></div>
    <hr/>

    <label for="issuerPostalCode">PSC: </label>
    <input type="text" th:field="*{issuer.postalCode}" id="issuerPostalCode"/>
    <div th:if="${#fields.hasErrors('issuer.postalCode')}" th:errors="*{issuer.postalCode}"></div>
    <hr/>

    <label for="issuerIco">ICO: </label>
    <input type="text" th:field="*{issuer.ico}" id="issuerIco"/>
    <div th:if="${#fields.hasErrors('issuer.ico')}" th:errors="*{issuer.ico}"></div>
    <hr/>

    <label for="issuerDic">DIC: </label>
    <input type="text" th:field="*{issuer.dic}" id="issuerDic"/>
    <div th:if="${#fields.hasErrors('issuer.dic')}" th:errors="*{issuer.dic}"></div>
    <hr/>

    <label for="issuerPhone">Telefon: </label>
    <input type="text" th:field="*{issuer.phone}" id="issuerPhone"/>
    <div th:if="${#fields.hasErrors('issuer.phone')}" th:errors="*{issuer.phone}"></div>
    <hr/>

    <label for="issuerEmail">Email: </label>
    <input type="email" th:field="*{issuer.email}" id="issuerEmail"/>
    <div th:if="${#fields.hasErrors('issuer.email')}" th:errors="*{issuer.email}"></div>
    <hr/>

    <label for="issuerBankAccount">Ucet: </label>
    <input type="text" th:field="*{issuer.bankAccount}" id="issuerBankAccount"/>
    <div th:if="${#fields.hasErrors('issuer.bankAccount')}" th:errors="*{issuer.bankAccount}"></div>
    <hr/>

    <h2>Udaje klienta</h2>

    <label for="clientName">Meno: </label>
    <input type="text" th:field="*{client.name}" id="clientName"/>
    <div th:if="${#fields.hasErrors('client.name')}" th:errors="*{client.name}"></div>
    <hr/>

    <label for="clientStreet">Ulica: </label>
    <input type="text" th:field="*{client.street}" id="clientStreet"/>
    <div th:if="${#fields.hasErrors('client.street')}" th:errors="*{client.street}"></div>
    <hr/>

    <label for="clientHouseNumber">Cislo domu: </label>
    <input type="text" th:field="*{client.houseNumber}" id="clientHouseNumber"/>
    <div th:if="${#fields.hasErrors('client.houseNumber')}" th:errors="*{client.houseNumber}"></div>
    <hr/>

    <label for="clientCity">Mesto: </label>
    <input type="text" th:field="*{client.city}" id="clientCity"/>
    <div th:if="${#fields.hasErrors('client.city')}" th:errors="*{client.city}"></div>
    <hr/>

    <label for="clientPostalCode">PSC: </label>
    <input type="text" th:field="*{client.postalCode}" id="clientPostalCode"/>
    <div th:if="${#fields.hasErrors('client.postalCode')}" th:errors="*{client.postalCode}"></div>
    <hr/>

    <label for="clientIco">ICO: </label>
    <input type="text" th:field="*{client.ico}" id="clientIco"/>
    <div th:if="${#fields.hasErrors('client.ico')}" th:errors="*{client.ico}"></div>
    <hr/>

    <label for="clientDic">DIC: </label>
    <input type="text" th:field="*{client.dic}" id="clientDic"/>
    <div th:if="${#fields.hasErrors('client.dic')}" th:errors="*{client.dic}"></div>
    <hr/>

    <label for="clientPhone">Telefon: </label>
    <input type="text" th:field="*{client.phone}" id="clientPhone"/>
    <div th:if="${#fields.hasErrors('client.phone')}" th:errors="*{client.phone}"></div>
    <hr/>
    
    <label for="clientEmail">Email: </label>
    <input type="email" th:field="*{client.email}" id="clientEmail"/>
    <div th:if="${#fields.hasErrors('client.email')}" th:errors="*{client.email}"></div>
    <hr/>

    <h2>Fakturacne udaje</h2>

    <label for="invoiceNumber">Cislo faktury: </label>
    <input type="text" th:field="*{invoiceNumber}" id="invoiceNumber"/>
    <div th:if="${#fields.hasErrors('invoiceNumber')}" th:errors="*{invoiceNumber}"></div>
    <hr/>

    <label for="variableSymbol">Variabilny symbol: </label>
    <input type="text" th:field="*{variableSymbol}" id="variableSymbol"/>
    <div th:if="${#fields.hasErrors('variableSymbol')}" th:errors="*{variableSymbol}"></div>
    <hr/>

    <label for="issueDate">Datum vystavenia: </label>
    <input type="date" th:field="*{issueDate}" id="issueDate"/>
    <div th:if="${#fields.hasErrors('issueDate')}" th:errors="*{issueDate}"></div>
    <hr/>

    <label for="deliveryDate">Datum dodania: </label>
    <input type="date" th:field="*{deliveryDate}" id="deliveryDate"/>
    <div th:if="${#fields.hasErrors('deliveryDate')}" th:errors="*{deliveryDate}"></div>
    <hr/>

    <label for="dueDate">Dátum splatnosti: </label>
    <input type="date" th:field="*{dueDate}" id="dueDate"/>
    <div th:if="${#fields.hasErrors('dueDate')}" th:errors="*{dueDate}"></div>
    <hr/>

    <h2>Polozky faktury</h2>

    <div id="items-container">
        <div th:each="item, iterStat : *{items}" class="invoice-item">
            <label th:for="'items[' + ${iterStat.index} + '].description'">Názov:</label>
            <input type="text" th:field="*{items[__${iterStat.index}__].description}" />
            <div th:if="${#fields.hasErrors('items[' + iterStat.index + '].description')}"
                 th:errors="*{items[__${iterStat.index}__].description}"></div>

            <label th:for="'items[' + ${iterStat.index} + '].quantity'">Množstvo:</label>
            <input type="number" th:field="*{items[__${iterStat.index}__].quantity}" />
            <div th:if="${#fields.hasErrors('items[' + iterStat.index + '].quantity')}"
                 th:errors="*{items[__${iterStat.index}__].quantity}"></div>

            <label th:for="'items[' + ${iterStat.index} + '].unitPrice'">Cena za kus:</label>
            <input type="number" th:field="*{items[__${iterStat.index}__].unitPrice}" />
            <div th:if="${#fields.hasErrors('items[' + iterStat.index + '].unitPrice')}"
                 th:errors="*{items[__${iterStat.index}__].unitPrice}"></div>

            <button type="button" onclick="removeItem(this)">Odstrániť</button>
            <hr/>
        </div>
    </div>
    <div id="item-template" style="display:none;">
        <div class="invoice-item">
            <label>Nazov:</label>
            <input type="text" data-name="items[__index__].description"/>
            <div></div>

            <label>Mnozstvo:</label>
            <input type="number" data-name="items[__index__].quantity"/>
            <div></div>

            <label>Cena za kus:</label>
            <input type="number" data-name="items[__index__].unitPrice"/>
            <div></div>

            <button type="button" onclick="removeItem(this)">Odstranit</button>
            <hr/>
        </div>
    </div>

    <button type="button" onclick="addItem()">Pridat dalsiu polozku</button>
    <button type="submit">Ulozit fakturu</button>
    <button type="button" onclick="window.location.href='/invoices'">Back</button>
</form>
<script>
    function addItem() {
        const container = document.getElementById("items-container");
        const template = document.getElementById("item-template").innerHTML;

        const index = container.querySelectorAll(".invoice-item").length;
        const wrapper = document.createElement("div");
        wrapper.innerHTML = template;

        const inputs = wrapper.querySelectorAll("[data-name]");
        inputs.forEach(input => {
            const nameTemplate = input.getAttribute("data-name");
            input.setAttribute("name", nameTemplate.replaceAll("__index__", index));
            input.removeAttribute("data-name");
        });

        container.appendChild(wrapper);
    }

    function removeItem(button) {
        const itemDiv = button.closest(".invoice-item");
        itemDiv.remove();
        reindexItems();
    }

    function reindexItems() {
        const itemDivs = document.querySelectorAll(".invoice-item");
        itemDivs.forEach((div, index) => {
            div.querySelectorAll("input, select").forEach(input => {
                const name = input.getAttribute("name");
                if (name) {
                    const newName = name.replace(/items\[\d+\]/, `items[${index}]`);
                    input.setAttribute("name", newName);
                    input.setAttribute("id", newName); // pre validáciu
                }
            });
        });
    }
</script>
</body>
</html>